{% extends 'base.html' %}
{% block title %}Pong{% endblock %}
{% block content %}
    <h2>Pong</h2>

    <style>
        #game-container { position: relative; width: 600px; height: 400px; margin: 0 auto; cursor: none; }
        #game-board { border: 3px solid #e0e0e0; background-color: #000; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 1.2em; }
        .difficulty-button { display: inline-block; text-decoration: none; padding: 15px 25px; margin: 10px; border-radius: 0; font-size: 1em; color: #FFFFFF; cursor: pointer; border: 2px solid; font-family: 'Press Start 2P', cursive; }
        .easy { background-color: #28a745; border-color: #28a745; }
        .medium { background-color: #ffc107; border-color: #ffc107; color: #1a1a2e;}
        .hard { background-color: #dc3545; border-color: #dc3545; }
    </style>

    <div id="game-container">
        <canvas id="game-board" width="600" height="400"></canvas>
        <div id="overlay">
            <h3>PONG</h3>
            <p>Wähle eine Schwierigkeit:</p>
             <div>
                <button class="difficulty-button easy" onclick="startGame('easy')">Leicht</button>
                <button class="difficulty-button medium" onclick="startGame('medium')">Mittel</button>
                <button class="difficulty-button hard" onclick="startGame('hard')">Schwer</button>
            </div>
            <p style="font-size: 0.8em; margin-top: 40px;">Steuerung: Maus<br>Wer zuerst 5 Punkte hat, gewinnt.</p>
        </div>
    </div>
    
    <script>
        const canvas = document.getElementById('game-board');
        const context = canvas.getContext('2d');
        const overlay = document.getElementById('overlay');
        
        const WINNING_SCORE = 5;
        const ball = { x: canvas.width / 2, y: canvas.height / 2, radius: 7, speed: 5, dx: 5, dy: 5 };
        const player = { x: 10, y: canvas.height / 2 - 40, width: 10, height: 80, score: 0 };
        const computer = { x: canvas.width - 20, y: canvas.height / 2 - 40, width: 10, height: 80, score: 0 };
        
        let gameLoopId, currentDifficulty;

        function startGame(difficulty) {
            currentDifficulty = difficulty;
            player.score = 0;
            computer.score = 0;
            resetBall();
            overlay.style.display = 'none';
            
            cancelAnimationFrame(gameLoopId);
            gameLoopId = requestAnimationFrame(update);
        }
        
        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.speed = 5;
            ball.dx = Math.random() > 0.5 ? 5 : -5;
            ball.dy = Math.random() > 0.5 ? 5 : -5;
        }

        function draw() {
            context.fillStyle = '#000';
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.strokeStyle = '#e0e0e0';
            context.lineWidth = 4;
            context.beginPath();
            context.setLineDash([10, 10]);
            context.moveTo(canvas.width / 2, 0);
            context.lineTo(canvas.width / 2, canvas.height);
            context.stroke();
            context.setLineDash([]);
            context.fillStyle = '#e0e0e0';
            context.font = "40px 'Press Start 2P'";
            context.fillText(player.score, canvas.width / 4, 50);
            context.fillText(computer.score, 3 * canvas.width / 4, 50);
            context.beginPath();
            context.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            context.fill();
            context.fillRect(player.x, player.y, player.width, player.height);
            context.fillRect(computer.x, computer.y, computer.width, computer.height);
        }

        function update() {
            ball.x += ball.dx;
            ball.y += ball.dy;

            const aiSpeedMap = { easy: 0.07, medium: 0.1, hard: 0.13 };
            computer.y += (ball.y - (computer.y + computer.height / 2)) * aiSpeedMap[currentDifficulty];

            if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) ball.dy *= -1;
            
            let paddle = (ball.x < canvas.width / 2) ? player : computer;
            if (ball.x - ball.radius < paddle.x + paddle.width && ball.x + ball.radius > paddle.x &&
                ball.y - ball.radius < paddle.y + paddle.height && ball.y + ball.radius > paddle.y) {
                ball.dx *= -1;
                ball.speed += 0.5;
                ball.dx = ball.dx > 0 ? ball.speed : -ball.speed;
            }
            
            if (ball.x + ball.radius > canvas.width) { player.score++; resetBall(); }
            else if (ball.x - ball.radius < 0) { computer.score++; resetBall(); }

            draw();

            if (player.score >= WINNING_SCORE) gameOver(true);
            else if (computer.score >= WINNING_SCORE) gameOver(false);
            else gameLoopId = requestAnimationFrame(update);
        }
        
        function gameOver(playerWon) {
            cancelAnimationFrame(gameLoopId);
            overlay.style.display = 'flex';
            const scoreDifference = Math.abs(player.score - computer.score);

            if (playerWon) {
                 overlay.innerHTML = `
                    <h3>Du hast gewonnen!</h3><p>Endstand: ${player.score} zu ${computer.score}</p>
                    <form id="highscore-form"><input type="text" id="player-name" placeholder="Dein Name..." required><button type="submit">Highscore (${scoreDifference} Pkt.) speichern</button></form>
                    <p style="margin-top:20px; font-size: 0.8em">Neues Spiel:</p>
                    <div><button class="difficulty-button easy" onclick="startGame('easy')">Leicht</button><button class="difficulty-button medium" onclick="startGame('medium')">Mittel</button><button class="difficulty-button hard" onclick="startGame('hard')">Schwer</button></div>`;
                
                document.getElementById('highscore-form').addEventListener('submit', function(event) {
                    event.preventDefault();
                    fetch("{% url 'games:save_score' %}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                        body: JSON.stringify({ player_name: document.getElementById('player-name').value, score: scoreDifference, game: 'Pong', difficulty: currentDifficulty })
                    }).then(() => window.location.href = "{% url 'games:highscores' %}");
                });
            } else {
                overlay.innerHTML = `
                    <h3>Computer hat gewonnen!</h3><p>Endstand: ${player.score} zu ${computer.score}</p>
                    <p style="margin-top:20px; font-size: 0.8em">Neues Spiel:</p>
                    <div><button class="difficulty-button easy" onclick="startGame('easy')">Leicht</button><button class="difficulty-button medium" onclick="startGame('medium')">Mittel</button><button class="difficulty-button hard" onclick="startGame('hard')">Schwer</button></div>`;
            }
        }

        canvas.addEventListener('mousemove', e => {
            const rect = canvas.getBoundingClientRect();
            player.y = e.clientY - rect.top - player.height / 2;
        });
    </script>
{% endblock %}
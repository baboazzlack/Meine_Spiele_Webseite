{% extends 'base.html' %}
{% load static %}

{% block title %}Simple Invaders - GFN Retro Hub{% endblock %}

{% block content %}
<main class="main-content">
    <div class.si-game-wrapper">
        <div class="si-ui-panel">
            <div id="si-score">SCORE: 0</div>
            <div id="si-lives">LIVES: 3</div>
        </div>
        <canvas id="si-game-canvas"></canvas>
        <div id="si-start-overlay" class="si-game-overlay">
            <h2>SIMPLE INVADERS</h2>
            <div class="si-difficulty-select">
                <button data-difficulty="easy">LEICHT</button>
                <button data-difficulty="medium">MITTEL</button>
                <button data-difficulty="hard">SCHWER</button>
            </div>
        </div>
        <div id="si-game-over-overlay" class="si-game-overlay hidden">
            <h2>GAME OVER</h2>
            <p id="si-final-score">DEIN SCORE: 0</p>
            <form id="si-highscore-form">
                <input type="text" id="player-name" placeholder="DEIN NAME" maxlength="10" required>
                <button type="submit">SPEICHERN</button>
            </form>
            <button id="si-restart-btn">NEUSTART</button>
        </div>
    </div>
    <div id="mobile-controls" class="mobile-btn-container si-controls">
        <div class="d-pad">
            <div id="btn-left" class="mobile-btn">&lt;</div>
            <div id="btn-right" class="mobile-btn">&gt;</div>
        </div>
        <div class="action-buttons">
            <div id="btn-fire" class="mobile-btn">FIRE</div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/games/simple_invaders_logic.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTE & KONTEXT ---
    const canvas = document.getElementById('si-game-canvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('si-score');
    const livesEl = document.getElementById('si-lives');
    const startOverlay = document.getElementById('si-start-overlay');
    const gameOverOverlay = document.getElementById('si-game-over-overlay');
    const finalScoreEl = document.getElementById('si-final-score');
    const restartBtn = document.getElementById('si-restart-btn');
    const difficultyButtons = document.querySelectorAll('.si-difficulty-select button');
    const highscoreForm = document.getElementById('si-highscore-form');
    const playerNameInput = document.getElementById('player-name');
    const mobileControls = document.getElementById('mobile-controls');
    
    function resizeCanvas() { canvas.width = 800; canvas.height = 600; }
    resizeCanvas();

    // --- SPIEL-ZUSTAND ---
    let player, invaderGrid, projectiles, invaderProjectiles, score, lives, game, difficulty, keys, frame, animationId;
    const difficulties = { easy: { speed: 1.5, fireRate: 100 }, medium: { speed: 2.5, fireRate: 60 }, hard: { speed: 4, fireRate: 35 }};

    function init() {
        player = createPlayer(canvas);
        invaderGrid = createInvaderGrid();
        projectiles = [];
        invaderProjectiles = [];
        score = 0; lives = 3; frame = 0;
        keys = { a: false, d: false, space: false };
        game = { active: true, over: false };
        scoreEl.innerText = 'SCORE: 0';
        livesEl.innerText = 'LIVES: 3';
        invaderGrid.speedX = difficulty.speed;
    }

    function animate() {
        animationId = requestAnimationFrame(animate);
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        player.update();
        player.draw(ctx);

        if (keys.a) player.speed = -5;
        else if (keys.d) player.speed = 5;
        else player.speed = 0;
        
        projectiles.forEach((p, i) => { if (p.y < 0) projectiles.splice(i, 1); else { p.update(); p.draw(ctx); } });
        invaderProjectiles.forEach((p, i) => { p.update(); p.draw(ctx); if (p.y > canvas.height) invaderProjectiles.splice(i, 1); if (p.y + p.height >= player.y && p.x >= player.x && p.x + p.width <= player.x + player.width) { invaderProjectiles.splice(i, 1); lives--; livesEl.innerText = `LIVES: ${lives}`; if (lives <= 0) endGame(); } });

        invaderGrid.x += invaderGrid.speedX;
        let changeDirection = false;
        invaderGrid.invaders.forEach(invader => {
            const absoluteX = invader.x + invaderGrid.x;
            if (absoluteX <= 0 || absoluteX + invader.width >= canvas.width) { changeDirection = true; }
            invader.draw(ctx, invaderGrid.x, invaderGrid.y);
        });
        if (changeDirection) { invaderGrid.speedX *= -1; invaderGrid.y += 20; }
        
        if (frame % difficulty.fireRate === 0 && invaderGrid.invaders.length > 0) { const randomInvader = invaderGrid.invaders[Math.floor(Math.random() * invaderGrid.invaders.length)]; invaderProjectiles.push(createProjectile(randomInvader.x + invaderGrid.x + randomInvader.width / 2, randomInvader.y + invaderGrid.y + randomInvader.height, '#ffcc00', 3)); }

        projectiles.forEach((p, pIndex) => { invaderGrid.invaders.forEach((invader, iIndex) => { const invaderX = invader.x + invaderGrid.x; const invaderY = invader.y + invaderGrid.y; if (p.x > invaderX && p.x < invaderX + invader.width && p.y > invaderY && p.y < invaderY + invader.height) { setTimeout(() => { if(invaderGrid.invaders.includes(invader)) { invaderGrid.invaders.splice(iIndex, 1); projectiles.splice(pIndex, 1); score += 100; scoreEl.innerText = `SCORE: ${score}`; } }, 0); } }); });
        
        if (invaderGrid.invaders.length === 0) endGame(true);
        frame++;
    }

    function startGame(diff) {
        difficulty = difficulties[diff];
        init();
        startOverlay.classList.add('hidden'); // Blendet das MenÃ¼ aus
        game.active = true;
        animate();
    }
    function endGame(win = false) {
        if (game.over) return;
        game.active = false; game.over = true;
        cancelAnimationFrame(animationId);
        if (win) score += 1000;
        finalScoreEl.innerText = `DEIN SCORE: ${score}`;
        gameOverOverlay.classList.remove('hidden');
    }

    difficultyButtons.forEach(b => b.addEventListener('click', () => startGame(b.dataset.difficulty)));
    restartBtn.addEventListener('click', () => { gameOverOverlay.classList.add('hidden'); startOverlay.classList.remove('hidden'); });
    highscoreForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = playerNameInput.value.trim().toUpperCase(); if (!name) return; try { await fetch("{% url 'games:save_score' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }, body: JSON.stringify({ player_name: name, game: 'Simple Invaders', score: score }) }); } catch (err) { console.error(err); } finally { playerNameInput.value = ''; restartBtn.click(); } });
    
    function keyHandler(e) { if (!game.active && e.type === 'keydown') return; const state = e.type === 'keydown'; switch (e.key) { case 'a': case 'ArrowLeft': keys.a = state; break; case 'd': case 'ArrowRight': keys.d = state; break; case ' ': case 'ArrowUp': if (state && !keys.space) { projectiles.push(createProjectile(player.x + player.width / 2, player.y, '#00ffff', -5)); keys.space = true; } else if (!state) { keys.space = false; } break; } }
    addEventListener('keydown', keyHandler); addEventListener('keyup', keyHandler);

    if ('ontouchstart' in window) {
        mobileControls.classList.add('visible');
        const touchHandler = (key, state) => (e) => { e.preventDefault(); if (game.active) keys[key] = state; };
        const fireHandler = (state) => (e) => { e.preventDefault(); if (game.active && state && !keys.space) { projectiles.push(createProjectile(player.x + player.width / 2, player.y, '#00ffff', -5)); keys.space = true; } else if (!state) { keys.space = false; } };
        const leftBtn = document.getElementById('btn-left'), rightBtn = document.getElementById('btn-right'), fireBtn = document.getElementById('btn-fire');
        leftBtn.addEventListener('touchstart', touchHandler('a', true)); leftBtn.addEventListener('touchend', touchHandler('a', false));
        rightBtn.addEventListener('touchstart', touchHandler('d', true)); rightBtn.addEventListener('touchend', touchHandler('d', false));
        fireBtn.addEventListener('touchstart', fireHandler(true)); fireBtn.addEventListener('touchend', fireHandler(false));
    }
});
</script>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block title %}Space Invaders - GFN Retro Hub{% endblock %}

{% block content %}
<main class="main-content">
    <h2>Space Invaders</h2>
    <p id="instruction">Wähle deine Mission (Schwierigkeit).</p>

    <div id="difficultySelector">
        <button class="difficulty-btn" data-difficulty="easy">Kadett</button>
        <button class="difficulty-btn" data-difficulty="medium">Pilot</button>
        <button class="difficulty-btn" data-difficulty="hard">Commander</button>
    </div>

    <div id="gameContainer" style="display: none; position: relative;">
        <div style="display: flex; justify-content: space-between; max-width: 600px; margin: auto; padding: 0 10px;">
            <div id="score" style="font-size: 1.2em; margin-bottom: 10px;">Score: 0</div>
            <div id="lives" style="font-size: 1.2em; margin-bottom: 10px;">Lives: 3</div>
        </div>
        <canvas id="gameCanvas" width="600" height="600" style="background-color: #000; border: 3px solid #00ffff;"></canvas>
    </div>
    
    <div id="mobile-controls">
        <div class="d-pad">
            <button id="btn-left" class="mobile-btn" style="top: 50px; left: 10px; width: 80px; height: 50px;">◄</button>
            <button id="btn-right" class="mobile-btn" style="top: 50px; left: 100px; width: 80px; height: 50px;">►</button>
        </div>
        <div class="action-buttons">
            <button id="btn-fire" class="mobile-btn">FIRE</button>
        </div>
    </div>

    <div id="gameOverModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; flex-direction: column;">
        <h2 id="finalScore"></h2>
        <form id="highscoreForm"><input type="text" id="playerName" placeholder="Dein Name" required><button type="submit">SPEICHERN</button></form>
        <button onclick="document.location.reload()">NEUSTART</button>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const difficultySelector = document.getElementById('difficultySelector');
        const gameContainer = document.getElementById('gameContainer');
        const instruction = document.getElementById('instruction');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreEl = document.getElementById('finalScore');
        const highscoreForm = document.getElementById('highscoreForm');

        let score = 0, lives = 3, frames = 0, game;
        const keys = {};

        // Schwierigkeitsstufen: speed (Pixel pro Frame), fireInterval (Frames zwischen Schüssen), lives
        const difficultySettings = {
            easy:   { speed: 0.2, fireInterval: 100, lives: 4 },
            medium: { speed: 0.4, fireInterval: 70, lives: 3 },
            hard:   { speed: 0.8, fireInterval: 50, lives: 2 }
        };

        // --- Sound Engine (erzeugt Töne per Code) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            if (type === 'shoot') {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
            } else if (type === 'invaderKill') {
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
            } else if (type === 'playerDie') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(400, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.5);
                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
            }
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + 0.5);
        }
        
        // --- Spiel-Klassen ---
        class Player {
            constructor() { this.x = canvas.width / 2; this.y = canvas.height - 50; this.width = 44; this.height = 22; this.speed = 5; }
            draw() {
                ctx.fillStyle = '#00ff00';
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x - this.width/2, this.y + this.height);
                ctx.lineTo(this.x + this.width/2, this.y + this.height);
                ctx.closePath();
                ctx.fill();
            }
            update() { if ((keys.a || keys.arrowleft) && this.x > this.width/2) this.x -= this.speed; if ((keys.d || keys.arrowright) && this.x < canvas.width - this.width/2) this.x += this.speed; }
        }

        class Projectile {
            constructor(x, y, velocity) { this.x = x; this.y = y; this.velocity = velocity; this.width=3; this.height=10; }
            draw() { ctx.fillStyle = this.velocity < 0 ? 'white' : 'red'; ctx.fillRect(this.x - this.width/2, this.y, this.width, this.height); }
            update() { this.y += this.velocity; }
        }

        class Invader {
            constructor(x, y) { this.x = x; this.y = y; this.width = 32; this.height = 24; }
            draw(gridX, gridY) {
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(this.x + gridX, this.y + gridY, this.width, this.height);
            }
        }
        
        class Shield {
            constructor(x, y) {
                this.x = x; this.y = y;
                this.blockSize = 8;
                this.blocks = [];
                for(let i = 0; i < 8; i++) {
                    this.blocks[i] = [];
                    for (let j = 0; j < 5; j++) {
                        this.blocks[i][j] = 1; // 1 = intakt
                    }
                }
            }
            draw() {
                ctx.fillStyle = '#00ff00';
                for(let i = 0; i < 8; i++) {
                    for (let j = 0; j < 5; j++) {
                        if (this.blocks[i][j]) {
                            ctx.fillRect(this.x + i * this.blockSize, this.y + j * this.blockSize, this.blockSize, this.blockSize);
                        }
                    }
                }
            }
        }

        class Game {
            constructor(difficulty) {
                this.player = new Player();
                this.projectiles = [];
                this.invaderProjectiles = [];
                this.invaderGrid = [];
                this.shields = [];
                this.keys = {};
                this.animationFrameId = null;
                
                const settings = difficultySettings[difficulty];
                this.invaderSpeed = settings.speed;
                this.invaderFireInterval = settings.fireInterval;
                lives = settings.lives;
                livesEl.textContent = `Lives: ${lives}`;
                
                // Erstelle die Alien-Grid
                const cols = 10, rows = 5, spacing = 45;
                for (let i = 0; i < cols; i++) {
                    for (let j = 0; j < rows; j++) {
                        this.invaderGrid.push(new Invader(i * spacing + 50, j * spacing + 50));
                    }
                }
                
                // Erstelle die Schutzschilde
                for (let i = 0; i < 4; i++) {
                    this.shields.push(new Shield(i * 130 + 60, 450));
                }

                this.gridDirection = 1;
                this.gridY = 0;
            }
            
            updateGrid() {
                let moveDown = false;
                for(const invader of this.invaderGrid) {
                    if ((this.gridDirection > 0 && invader.x + this.gridDirection * this.invaderSpeed + invader.width > canvas.width) ||
                        (this.gridDirection < 0 && invader.x + this.gridDirection * this.invaderSpeed < 0)) {
                        moveDown = true;
                        break;
                    }
                }

                if (moveDown) {
                    this.gridDirection *= -1;
                    this.gridY += 20;
                } else {
                    this.invaderGrid.forEach(invader => invader.x += this.gridDirection * this.invaderSpeed);
                }
            }
            
            run() {
                this.player.update(this.keys);
                this.updateGrid();
                
                // Alien schießt
                if (frames % this.invaderFireInterval === 0 && this.invaderGrid.length > 0) {
                    const randomInvader = this.invaderGrid[Math.floor(Math.random() * this.invaderGrid.length)];
                    this.invaderProjectiles.push(new Projectile(randomInvader.x + randomInvader.width / 2, randomInvader.y + this.gridY + randomInvader.height, 5));
                }
                
                // Update projectiles
                this.projectiles.forEach((p, i) => { p.update(); if (p.y < 0) this.projectiles.splice(i, 1); });
                this.invaderProjectiles.forEach((p, i) => { p.update(); if (p.y > canvas.height) this.invaderProjectiles.splice(i, 1); });
                
                // Collision Detection: Player Projectile -> Invader
                for(let i = this.projectiles.length - 1; i >= 0; i--) {
                    for(let j = this.invaderGrid.length - 1; j >= 0; j--) {
                        const p = this.projectiles[i];
                        const invader = this.invaderGrid[j];
                        if (p.x > invader.x && p.x < invader.x + invader.width && p.y > invader.y + this.gridY && p.y < invader.y + this.gridY + invader.height) {
                            this.projectiles.splice(i, 1);
                            this.invaderGrid.splice(j, 1);
                            score += 100;
                            scoreEl.textContent = `Score: ${score}`;
                            playSound('invaderKill');
                            break;
                        }
                    }
                }
                
                // Collision Detection: Invader Projectile -> Player
                for(let i = this.invaderProjectiles.length - 1; i >= 0; i--) {
                    const p = this.invaderProjectiles[i];
                    if (p.x > this.player.x - this.player.width/2 && p.x < this.player.x + this.player.width/2 && p.y > this.player.y && p.y < this.player.y + this.player.height) {
                        this.invaderProjectiles.splice(i, 1);
                        lives--;
                        livesEl.textContent = `Lives: ${lives}`;
                        playSound('playerDie');
                        if (lives <= 0) { gameOver(this); return; }
                    }
                }

                // Game Over Check
                if (this.invaderGrid.length > 0 && this.invaderGrid.some(inv => inv.y + this.gridY + inv.height >= this.player.y)) {
                    gameOver(this); return;
                }
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                this.player.draw();
                this.projectiles.forEach(p => p.draw());
                this.invaderProjectiles.forEach(p => p.draw());
                this.invaderGrid.forEach(invader => invader.draw(0, this.gridY));
                this.shields.forEach(s => s.draw());
                
                frames++;
                this.animationFrameId = requestAnimationFrame(() => this.run());
            }
        }

        difficultySelector.addEventListener('click', e => { if(e.target.classList.contains('difficulty-btn')) { difficultySelector.style.display = 'none'; instruction.style.display = 'none'; gameContainer.style.display = 'block'; game = new Game(e.target.dataset.difficulty); game.run(); } });
        
        function playerFire() { if(game && game.projectiles.length < 3) { game.projectiles.push(new Projectile(game.player.x, game.player.y, -8)); playSound('shoot'); } }
        
        document.addEventListener('keydown', e => { const key = e.key.toLowerCase(); if(game) game.keys[key] = true; if(key === ' ') playerFire(); });
        document.addEventListener('keyup', e => { const key = e.key.toLowerCase(); if(game) game.keys[key] = false; });
        
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnFire = document.getElementById('btn-fire');

        btnLeft.addEventListener('touchstart', e => { e.preventDefault(); if(game) game.keys['a'] = true; });
        btnLeft.addEventListener('touchend', e => { e.preventDefault(); if(game) game.keys['a'] = false; });
        btnRight.addEventListener('touchstart', e => { e.preventDefault(); if(game) game.keys['d'] = true; });
        btnRight.addEventListener('touchend', e => { e.preventDefault(); if(game) game.keys['d'] = false; });
        btnFire.addEventListener('touchstart', e => { e.preventDefault(); playerFire(); });
        
        function gameOver(gameInstance) { if (gameInstance && gameInstance.animationFrameId) cancelAnimationFrame(gameInstance.animationFrameId); finalScoreEl.textContent = `Game Over! Score: ${score}`; gameOverModal.style.display = 'flex'; }
        
        highscoreForm.addEventListener('submit', e => { e.preventDefault(); fetch("{% url 'games:save_score' %}", { method: 'POST', headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'}, body: JSON.stringify({ player_name: document.getElementById('playerName').value, game: 'Space Invaders', score: score }) }).then(() => window.location.href = "{% url 'games:highscores' %}"); });
    });
</script>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block title %}Space Invaders - GFN Retro Hub{% endblock %}

{% block content %}
<main class="main-content">
    <h2>Space Invaders</h2>
    <p id="instruction">Wähle deine Mission (Schwierigkeit).</p>

    <div id="difficultySelector">
        <button class="difficulty-btn" data-difficulty="easy">Kadett</button>
        <button class="difficulty-btn" data-difficulty="medium">Pilot</button>
        <button class="difficulty-btn" data-difficulty="hard">Commander</button>
    </div>

    <div id="gameContainer" style="display: none; position: relative;">
        <div style="display: flex; justify-content: space-between; max-width: 600px; margin: auto;">
            <div id="score" style="font-size: 1.5em; margin-bottom: 10px;">Score: 0</div>
            <div id="lives" style="font-size: 1.5em; margin-bottom: 10px;">Lives: ♥♥♥</div>
        </div>
        <canvas id="gameCanvas" width="600" height="600" style="background-color: #000; border: 3px solid #00ffff;"></canvas>
    </div>
    
    <div id="mobile-controls">
        <div class="d-pad">
            <button id="btn-left" class="mobile-btn" style="top: 50px; left: 10px; width: 80px; height: 50px;">◄</button>
            <button id="btn-right" class="mobile-btn" style="top: 50px; left: 100px; width: 80px; height: 50px;">►</button>
        </div>
        <div class="action-buttons">
            <button id="btn-fire" class="mobile-btn">FIRE</button>
        </div>
    </div>

    <div id="gameOverModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; flex-direction: column;">
        <h2 id="finalScore"></h2>
        <form id="highscoreForm"><input type="text" id="playerName" placeholder="Dein Name" required><button type="submit">SPEICHERN</button></form>
        <button onclick="document.location.reload()">NEUSTART</button>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const difficultySelector = document.getElementById('difficultySelector');
        const gameContainer = document.getElementById('gameContainer');
        const instruction = document.getElementById('instruction');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreEl = document.getElementById('finalScore');
        const highscoreForm = document.getElementById('highscoreForm');

        let score = 0, lives = 3, frames = 0, game;
        
        const difficultySettings = {
            easy:   { speed: 0.5, fireRate: 90, bulletSpeed: 4 },
            medium: { speed: 1,   fireRate: 60, bulletSpeed: 6 },
            hard:   { speed: 1.5, fireRate: 40, bulletSpeed: 8 }
        };

        class Player {
            constructor() { this.x = canvas.width / 2; this.y = canvas.height - 50; this.width = 40; this.height = 20; this.speed = 5; }
            draw() { ctx.fillStyle = '#00ff00'; ctx.fillRect(this.x - this.width/2, this.y, this.width, this.height); }
            update(keys) { if ((keys.a || keys.arrowleft) && this.x > this.width/2) this.x -= this.speed; if ((keys.d || keys.arrowright) && this.x < canvas.width - this.width/2) this.x += this.speed; }
        }

        class Projectile {
            constructor(x, y, velocity) { this.x = x; this.y = y; this.velocity = velocity; this.radius = 4; }
            draw() { ctx.fillStyle = this.velocity < 0 ? 'white' : 'red'; ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill(); }
            update() { this.y += this.velocity; }
        }
        
        class Invader {
            constructor(x, y) { this.x = x; this.y = y; this.width = 30; this.height = 30; }
            draw(gridX, gridY) { ctx.fillStyle = '#ffff00'; ctx.fillRect(this.x + gridX - this.width/2, this.y + gridY, this.width, this.height); }
        }

        class Grid {
            constructor(speed) {
                this.x = 0; this.y = 30; this.velocity = speed;
                this.invaders = [];
                const cols = 10, rows = 5, spacing = 45;
                for (let i = 0; i < cols; i++) for (let j = 0; j < rows; j++) this.invaders.push(new Invader(i * spacing + 70, j * spacing + 50));
                this.width = (cols - 1) * spacing + 30;
            }
            update() {
                this.x += this.velocity;
                if (this.x + this.width >= canvas.width || this.x <= 0) {
                    this.velocity *= -1;
                    this.y += 30;
                }
            }
        }

        class Game {
            constructor(difficulty) {
                this.player = new Player();
                this.projectiles = [];
                this.invaderProjectiles = [];
                this.grids = [new Grid(difficultySettings[difficulty].speed)];
                this.keys = {};
                this.fireRate = difficultySettings[difficulty].fireRate;
                this.bulletSpeed = difficultySettings[difficulty].bulletSpeed;
                this.animationFrameId = null;
            }
            
            run() {
                this.player.update(this.keys);
                this.projectiles.forEach((p, i) => { p.update(); if (p.y + p.radius < 0) this.projectiles.splice(i, 1); });
                this.invaderProjectiles.forEach((p, i) => { p.update(); if (p.y - p.radius > canvas.height) this.invaderProjectiles.splice(i, 1); });

                this.grids.forEach(grid => {
                    grid.update();
                    if (frames % this.fireRate === 0 && grid.invaders.length > 0) {
                        const randomInvader = grid.invaders[Math.floor(Math.random() * grid.invaders.length)];
                        this.invaderProjectiles.push(new Projectile(randomInvader.x + grid.x, randomInvader.y + grid.y, this.bulletSpeed));
                    }
                    
                    for (let i = grid.invaders.length - 1; i >= 0; i--) {
                        const invader = grid.invaders[i];
                        if (invader.y + grid.y > this.player.y) { gameOver(this); return; } // Invaders reached the bottom
                        for (let j = this.projectiles.length - 1; j >= 0; j--) {
                            const projectile = this.projectiles[j];
                            if (Math.hypot(projectile.x - (invader.x + grid.x), projectile.y - (invader.y + grid.y)) < 20) {
                                grid.invaders.splice(i, 1);
                                this.projectiles.splice(j, 1);
                                score += 100;
                                scoreEl.textContent = `Score: ${score}`;
                                break; 
                            }
                        }
                    }
                });
                
                for (let i = this.invaderProjectiles.length - 1; i >= 0; i--) {
                    const p = this.invaderProjectiles[i];
                    if (Math.hypot(p.x - this.player.x, p.y - this.player.y) < 15) {
                        this.invaderProjectiles.splice(i, 1);
                        lives--;
                        livesEl.textContent = `Lives: ${'♥'.repeat(lives)}`;
                        if (lives <= 0) { gameOver(this); return; }
                    }
                }
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                this.player.draw();
                this.projectiles.forEach(p => p.draw());
                this.invaderProjectiles.forEach(p => p.draw());
                this.grids.forEach(grid => grid.invaders.forEach(invader => invader.draw(grid.x, grid.y)));
                frames++;
                this.animationFrameId = requestAnimationFrame(() => this.run());
            }
        }

        difficultySelector.addEventListener('click', e => {
            if (e.target.classList.contains('difficulty-btn')) {
                difficultySelector.style.display = 'none';
                instruction.style.display = 'none';
                gameContainer.style.display = 'block';
                game = new Game(e.target.dataset.difficulty);
                game.run();
            }
        });

        function playerFire() {
            if(game && game.projectiles.length < 3) game.projectiles.push(new Projectile(game.player.x, game.player.y, -8));
        }
        
        document.addEventListener('keydown', e => { const key = e.key.toLowerCase(); if(game) game.keys[key] = true; if(key === ' ') playerFire(); });
        document.addEventListener('keyup', e => { const key = e.key.toLowerCase(); if(game) game.keys[key] = false; });
        
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnFire = document.getElementById('btn-fire');

        btnLeft.addEventListener('touchstart', e => { e.preventDefault(); if(game) game.keys['a'] = true; });
        btnLeft.addEventListener('touchend', e => { e.preventDefault(); if(game) game.keys['a'] = false; });
        btnRight.addEventListener('touchstart', e => { e.preventDefault(); if(game) game.keys['d'] = true; });
        btnRight.addEventListener('touchend', e => { e.preventDefault(); if(game) game.keys['d'] = false; });
        btnFire.addEventListener('touchstart', e => { e.preventDefault(); playerFire(); });
        
        function gameOver(gameInstance) {
            if (gameInstance && gameInstance.animationFrameId) cancelAnimationFrame(gameInstance.animationFrameId);
            finalScoreEl.textContent = `Game Over! Score: ${score}`;
            gameOverModal.style.display = 'flex';
        }
        
        highscoreForm.addEventListener('submit', e => {
            e.preventDefault();
            fetch("{% url 'games:save_score' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
                body: JSON.stringify({ player_name: document.getElementById('playerName').value, game: 'Space Invaders', score: score })
            }).then(() => window.location.href = "{% url 'games:highscores' %}");
        });
    });
</script>
{% endblock %}
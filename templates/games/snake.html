{% extends 'base.html' %}
{% load static %}

{% block title %}Snake - GFN Retro Hub{% endblock %}

{% block content %}
<main class="main-content">
    <div class="si-game-wrapper">
        <div class="si-ui-panel">
            <div id="score">SCORE: 0</div>
            <div id="lives-ui" class="hidden"></div>
        </div>
        <canvas id="game-canvas"></canvas>
        <div id="start-overlay" class="si-game-overlay">
            <h2>SNAKE</h2>
            <div class="si-difficulty-select">
                <button data-difficulty="easy">LEICHT</button>
                <button data-difficulty="medium">MITTEL</button>
                <button data-difficulty="hard">SCHWER</button>
            </div>
        </div>
        <div id="game-over-overlay" class="si-game-overlay hidden">
            <h2>GAME OVER</h2>
            <p id="final-score">DEIN SCORE: 0</p>
            <form id="highscore-form">
                <input type="text" id="player-name" placeholder="DEIN NAME" maxlength="10" required>
                <button type="submit">SPEICHERN</button>
            </form>
            <button id="restart-btn">NEUSTART</button>
        </div>
    </div>
    <div id="mobile-controls" class="pacman-controls">
        <div class="d-pad">
            <div id="btn-left" class="mobile-btn">&lt;</div>
            <div id="btn-right" class="mobile-btn">&gt;</div>
            <div id="btn-up" class="mobile-btn">^</div>
            <div id="btn-down" class="mobile-btn">v</div>
        </div>
        <div class="action-buttons"><div id="btn-fire" class="mobile-btn"></div></div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const startOverlay = document.getElementById('start-overlay');
    const gameOverOverlay = document.getElementById('game-over-overlay');
    const finalScoreEl = document.getElementById('final-score');
    const restartBtn = document.getElementById('restart-btn');
    const difficultyButtons = document.querySelectorAll('.si-difficulty-select button');
    const highscoreForm = document.getElementById('highscore-form');
    const playerNameInput = document.getElementById('player-name');
    const mobileControls = document.getElementById('mobile-controls');

    const TILE_SIZE = 20;
    const GRID_WIDTH = 25;
    const GRID_HEIGHT = 25;
    canvas.width = GRID_WIDTH * TILE_SIZE;
    canvas.height = GRID_HEIGHT * TILE_SIZE;
    
    let snake, food, score, game, difficulty, keys, animationId, frameCounter, velocity;
    const difficulties = { easy: { tickSpeed: 10 }, medium: { tickSpeed: 7 }, hard: { tickSpeed: 4 } };

    function getRandomGridPosition() {
        return { col: Math.floor(Math.random() * GRID_WIDTH), row: Math.floor(Math.random() * GRID_HEIGHT) };
    }

    function init() {
        snake = [{ col: 12, row: 12 }];
        food = getRandomGridPosition();
        score = 0; frameCounter = 0;
        velocity = { x: 0, y: 0 };
        keys = { up: false, down: false, left: false, right: false };
        game = { active: true, over: false };
        scoreEl.innerText = 'SCORE: 0';
    }

    function animate() {
        animationId = requestAnimationFrame(animate);
        if (frameCounter % difficulty.tickSpeed !== 0) { frameCounter++; return; }
        
        if (keys.up && velocity.y === 0) { velocity = { x: 0, y: -1 }; }
        else if (keys.down && velocity.y === 0) { velocity = { x: 0, y: 1 }; }
        else if (keys.left && velocity.x === 0) { velocity = { x: -1, y: 0 }; }
        else if (keys.right && velocity.x === 0) { velocity = { x: 1, y: 0 }; }

        // KORREKTUR: Die Logik wird nur ausgeführt, wenn sich die Schlange bewegt.
        if (velocity.x !== 0 || velocity.y !== 0) {
            const head = { col: snake[0].col + velocity.x, row: snake[0].row + velocity.y };

            if (head.col < 0 || head.col >= GRID_WIDTH || head.row < 0 || head.row >= GRID_HEIGHT) { return endGame(); }
            for (let i = 0; i < snake.length; i++) { if (head.col === snake[i].col && head.row === snake[i].row) { return endGame(); } }

            snake.unshift(head);
            if (head.col === food.col && head.row === food.row) { score += 10; scoreEl.innerText = `SCORE: ${score}`; food = getRandomGridPosition(); } 
            else { snake.pop(); }
        }

        ctx.fillStyle = 'black'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        snake.forEach((segment, index) => { ctx.fillStyle = index === 0 ? 'lime' : 'green'; ctx.fillRect(segment.col * TILE_SIZE, segment.row * TILE_SIZE, TILE_SIZE - 2, TILE_SIZE - 2); });
        ctx.fillStyle = 'red'; ctx.fillRect(food.col * TILE_SIZE, food.row * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        
        frameCounter++;
    }

    function startGame(diff) {
        difficulty = difficulties[diff];
        init();
        startOverlay.classList.add('hidden');
        game.active = true;
        animate();
    }
    function endGame() {
        if (game.over) return;
        game.active = false; game.over = true;
        cancelAnimationFrame(animationId);
        finalScoreEl.innerText = `DEIN SCORE: ${score}`;
        gameOverOverlay.classList.remove('hidden');
    }

    difficultyButtons.forEach(b => b.addEventListener('click', () => startGame(b.dataset.difficulty)));
    restartBtn.addEventListener('click', () => { gameOverOverlay.classList.add('hidden'); startOverlay.classList.remove('hidden'); });
    highscoreForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = playerNameInput.value.trim().toUpperCase(); if (!name) return; try { await fetch("{% url 'games:save_score' %}", { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' }, body: JSON.stringify({ player_name: name, game: 'Snake', score: score }) }); } catch (err) { console.error(err); } finally { playerNameInput.value = ''; restartBtn.click(); } });
    
    function keyHandler(e) { if (!game.active) return; switch (e.key) { case 'w': case 'ArrowUp': if(velocity.y === 0) keys = { up: true }; break; case 's': case 'ArrowDown': if(velocity.y === 0) keys = { down: true }; break; case 'a': case 'ArrowLeft': if(velocity.x === 0) keys = { left: true }; break; case 'd': case 'ArrowRight': if(velocity.x === 0) keys = { right: true }; break; } }
    addEventListener('keydown', keyHandler);

    if ('ontouchstart' in window) {
        mobileControls.classList.add('visible');
        const up = document.getElementById('btn-up'), down = document.getElementById('btn-down'), left = document.getElementById('btn-left'), right = document.getElementById('btn-right');
        up.addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.y === 0) keys = { up: true }; });
        down.addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.y === 0) keys = { down: true }; });
        left.addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.x === 0) keys = { left: true }; });
        right.addEventListener('touchstart', (e) => { e.preventDefault(); if(velocity.x === 0) keys = { right: true }; });
    }
});
</script>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block title %}Snake - GFN Retro Hub{% endblock %}

{% block content %}
<main class="main-content">
    <h2>Snake</h2>
    <p id="instruction">Wähle eine Geschwindigkeit.</p>

    <div id="difficultySelector">
        <button class="difficulty-btn" data-speed="150">Leicht</button>
        <button class="difficulty-btn" data-speed="100">Mittel</button>
        <button class="difficulty-btn" data-speed="60">Schwer</button>
    </div>
    
    <div id="gameContainer" style="display: none; position: relative;">
        <div id="score" style="font-size: 1.5em; margin-bottom: 10px;">Score: 0</div>
        <canvas id="gameCanvas" width="500" height="500" style="background-color: #050515; border: 3px solid #00ffff;"></canvas>
    </div>

    <div id="mobile-controls">
        <div class="d-pad">
            <button id="btn-up" class="mobile-btn">▲</button>
            <button id="btn-down" class="mobile-btn">▼</button>
            <button id="btn-left" class="mobile-btn">◄</button>
            <button id="btn-right" class="mobile-btn">►</button>
        </div>
    </div>
    
    <div id="gameOverModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; flex-direction: column;">
        <h2 id="finalScore"></h2>
        <form id="highscoreForm"><input type="text" id="playerName" placeholder="Dein Name" required><button type="submit">SPEICHERN</button></form>
        <button onclick="document.location.reload()">NEUSTART</button>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (alle Variablen von vorher bleiben gleich) ...
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const difficultySelector = document.getElementById('difficultySelector');
        const gameContainer = document.getElementById('gameContainer');
        const instruction = document.getElementById('instruction');
        const gameOverModal = document.getElementById('gameOverModal');
        const finalScoreEl = document.getElementById('finalScore');
        const highscoreForm = document.getElementById('highscoreForm');
        
        const gridSize = 20;
        let snake = [{x: 10, y: 10}];
        let food = {};
        let direction = 'right';
        let score = 0;
        let gameSpeed = 100;
        let gameLoop;

        difficultySelector.addEventListener('click', e => { /* ... (bleibt gleich) ... */ });

        function startGame() { /* ... (bleibt gleich) ... */ }
        function placeFood() { /* ... (bleibt gleich) ... */ }
        function update() { /* ... (bleibt gleich) ... */ }
        function isCollision() { /* ... (bleibt gleich) ... */ }
        function draw() { /* ... (bleibt gleich) ... */ }
        function gameOver() { /* ... (bleibt gleich) ... */ }
        
        // PC-Steuerung (bleibt unverändert)
        document.addEventListener('keydown', e => {
            const key = e.key;
            if ((key === 'ArrowUp' || key.toLowerCase() === 'w') && direction !== 'down') direction = 'up';
            if ((key === 'ArrowDown' || key.toLowerCase() === 's') && direction !== 'up') direction = 'down';
            if ((key === 'ArrowLeft' || key.toLowerCase() === 'a') && direction !== 'right') direction = 'left';
            if ((key === 'ArrowRight' || key.toLowerCase() === 'd') && direction !== 'left') direction = 'right';
        });

        // NEU: Mobile Touch-Steuerung
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');

        btnUp.addEventListener('touchstart', e => { e.preventDefault(); if (direction !== 'down') direction = 'up'; });
        btnDown.addEventListener('touchstart', e => { e.preventDefault(); if (direction !== 'up') direction = 'down'; });
        btnLeft.addEventListener('touchstart', e => { e.preventDefault(); if (direction !== 'right') direction = 'left'; });
        btnRight.addEventListener('touchstart', e => { e.preventDefault(); if (direction !== 'left') direction = 'right'; });

        // ... (Restliche Logik wie startGame, placeFood, highscoreForm etc. bleibt hier) ...
        difficultySelector.addEventListener('click', e => {
            if (e.target.classList.contains('difficulty-btn')) {
                gameSpeed = parseInt(e.target.dataset.speed);
                startGame();
            }
        });

        function startGame() {
            difficultySelector.style.display = 'none';
            instruction.style.display = 'none';
            gameContainer.style.display = 'block';
            placeFood();
            gameLoop = setInterval(update, gameSpeed);
        }

        function placeFood() {
            food = {
                x: Math.floor(Math.random() * (canvas.width / gridSize)),
                y: Math.floor(Math.random() * (canvas.height / gridSize))
            };
        }

        function update() {
            const head = { ...snake[0] };
            if (direction === 'up') head.y--;
            if (direction === 'down') head.y++;
            if (direction === 'left') head.x--;
            if (direction === 'right') head.x++;
            
            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreEl.textContent = `Score: ${score}`;
                placeFood();
            } else {
                snake.pop();
            }
            
            if (isCollision()) {
                gameOver();
                return;
            }

            draw();
        }

        function isCollision() {
            const head = snake[0];
            return head.x < 0 || head.x >= canvas.width / gridSize || head.y < 0 || head.y >= canvas.height / gridSize || snake.slice(1).some(segment => segment.x === head.x && segment.y === head.y);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            snake.forEach(segment => {
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 1, gridSize - 1);
            });
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(food.x * gridSize, food.y * gridSize, gridSize, gridSize);
        }
        
        function gameOver() {
            clearInterval(gameLoop);
            finalScoreEl.textContent = `Game Over! Score: ${score}`;
            gameOverModal.style.display = 'flex';
        }

        highscoreForm.addEventListener('submit', e => {
            e.preventDefault();
            const playerName = document.getElementById('playerName').value;
            fetch("{% url 'games:save_score' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ player_name: playerName, game: 'Snake', score: score })
            }).then(() => window.location.href = "{% url 'games:highscores' %}");
        });
    });
</script>
{% endblock %}
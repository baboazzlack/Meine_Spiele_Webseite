{% extends 'base.html' %}
{% load static %}

{% block title %}Galgenmännchen - GFN Retro Hub{% endblock %}

{% block content %}
<main class="game-container-main">
    <div class="game-header">
        <h1 class="game-title-h1">Galgenmännchen</h1>
        <p class="game-description">Errate das Wort, bevor die Neon-Figur komplett ist!</p>
    </div>

    <div class="game-controls">
        <label for="difficulty">Schwierigkeit:</label>
        <select id="difficulty">
            <option value="easy">Leicht</option>
            <option value="medium" selected>Mittel</option>
            <option value="hard">Schwer</option>
        </select>
        <button id="startGameBtn">Neues Spiel</button>
    </div>

    <div class="game-info-hangman">
        <p>Versuche: <span id="lives">8</span></p>
        <p>Zeit: <span id="timer">--</span></p>
        <p>Score: <span id="score">0</span></p>
    </div>

    <canvas id="hangmanCanvas" width="400" height="250"></canvas>

    <div id="wordDisplay" class="word-display"></div>

    <div id="keyboard" class="keyboard-container"></div>

    <div id="gameOverModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2 id="modalTitle">Verloren!</h2>
            <p>Das Wort war: <strong id="correctWord"></strong></p>
            <p>Dein Score: <span id="finalScore">0</span></p>
            <input type="text" id="playerNameInput" placeholder="Dein Name" maxlength="15">
            <div class="modal-actions">
                <button id="saveScoreBtn">Speichern</button>
                <button id="restartGameBtn">Neues Spiel</button>
                <button id="closeModalBtn">Schließen</button>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elemente ---
    const canvas = document.getElementById('hangmanCanvas');
    const ctx = canvas.getContext('2d');
    const difficultySelect = document.getElementById('difficulty');
    const startGameBtn = document.getElementById('startGameBtn');
    const wordDisplay = document.getElementById('wordDisplay');
    const keyboardContainer = document.getElementById('keyboard');
    const livesDisplay = document.getElementById('lives');
    const timerDisplay = document.getElementById('timer');
    const scoreDisplay = document.getElementById('score');
    const modal = document.getElementById('gameOverModal');
    const modalTitle = document.getElementById('modalTitle');
    const correctWordDisplay = document.getElementById('correctWord');
    const finalScoreElement = document.getElementById('finalScore');
    const playerNameInput = document.getElementById('playerNameInput');
    const saveScoreBtn = document.getElementById('saveScoreBtn');
    const restartGameBtn = document.getElementById('restartGameBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    // --- Spiel-Konstanten & Design ---
    const COLORS = {
        LINE: '#00ffff',
        GLOW: '#00ffff',
        TEXT: '#ffff00',
        FILL: '#ff00ff'
    };

    const words = {
        easy: ["HAUS", "AUTO", "BALL", "BUCH", "BAUM", "SPIEL", "MOND"],
        medium: ["COMPUTER", "PROGRAMM", "WEBSITE", "KEYBOARD", "PYTHON", "FLASCHE"],
        hard: ["ALGORITHMUS", "SCHNITTSTELLE", "DATENBANK", "BIBLIOTHEK", "FRAMEWORK"]
    };

    const difficultySettings = {
        easy: { lives: 8, time: null },
        medium: { lives: 7, time: 90 },
        hard: { lives: 6, time: 60 }
    };

    // --- Spiel-Variablen ---
    let currentWord, guessedLetters, wrongGuesses, score, timer, timeLeft, gameActive;

    function init() {
        gameActive = true;
        const difficulty = difficultySelect.value;
        const settings = difficultySettings[difficulty];
        
        const wordList = words[difficulty];
        currentWord = wordList[Math.floor(Math.random() * wordList.length)];
        
        guessedLetters = new Set();
        wrongGuesses = 0;
        score = 0;
        
        livesDisplay.textContent = settings.lives;
        scoreDisplay.textContent = '0';
        
        if (timer) clearInterval(timer);
        if (settings.time) {
            timeLeft = settings.time;
            timerDisplay.textContent = `${timeLeft}s`;
            timer = setInterval(updateTimer, 1000);
        } else {
            timerDisplay.textContent = '--';
        }
        
        modal.style.display = 'none';
        drawGallows();
        renderWordDisplay();
        renderKeyboard();
    }

    function renderWordDisplay() {
        wordDisplay.innerHTML = currentWord.split('').map(letter => 
            `<span class="letter">${guessedLetters.has(letter) ? letter : '_'}</span>`
        ).join('');
    }

    function renderKeyboard() {
        keyboardContainer.innerHTML = '';
        'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => {
            const btn = document.createElement('button');
            btn.textContent = letter;
            btn.classList.add('key');
            if (guessedLetters.has(letter)) {
                btn.disabled = true;
            }
            btn.addEventListener('click', () => handleGuess(letter));
            keyboardContainer.appendChild(btn);
        });
    }

    function handleGuess(letter) {
        if (!gameActive) return;

        guessedLetters.add(letter);
        const letterFound = currentWord.includes(letter);

        if (letterFound) {
            // Richtig geraten
            document.querySelectorAll('.key').forEach(btn => {
                if(btn.textContent === letter) {
                    btn.classList.add('correct');
                    btn.disabled = true;
                }
            });
        } else {
            // Falsch geraten
            wrongGuesses++;
            livesDisplay.textContent = difficultySettings[difficultySelect.value].lives - wrongGuesses;
            drawHangmanPart(wrongGuesses);
            document.querySelectorAll('.key').forEach(btn => {
                if(btn.textContent === letter) {
                    btn.classList.add('wrong');
                    btn.disabled = true;
                }
            });
        }
        
        renderWordDisplay();
        checkGameState();
    }

    function updateTimer() {
        timeLeft--;
        timerDisplay.textContent = `${timeLeft}s`;
        if (timeLeft <= 0) {
            clearInterval(timer);
            gameOver(false);
        }
    }

    function checkGameState() {
        const wordSolved = currentWord.split('').every(letter => guessedLetters.has(letter));
        const maxLives = difficultySettings[difficultySelect.value].lives;

        if (wordSolved) {
            gameOver(true);
        } else if (wrongGuesses >= maxLives) {
            gameOver(false);
        }
    }

    function gameOver(isWin) {
        gameActive = false;
        clearInterval(timer);

        if (isWin) {
            const remainingLives = difficultySettings[difficultySelect.value].lives - wrongGuesses;
            const timeBonus = timeLeft || 0;
            score = (remainingLives * 100) + timeBonus;
            modalTitle.textContent = "Gewonnen!";
            correctWordDisplay.parentElement.style.display = 'none';
        } else {
            score = 0;
            modalTitle.textContent = "Verloren!";
            correctWordDisplay.parentElement.style.display = 'block';
            correctWordDisplay.textContent = currentWord;
        }

        finalScoreElement.textContent = score;
        scoreDisplay.textContent = score;

        setTimeout(() => {
            modal.style.display = 'flex';
        }, 500);
    }
    
    // --- Canvas Zeichenfunktionen ---
    ctx.strokeStyle = COLORS.LINE;
    ctx.shadowColor = COLORS.GLOW;
    ctx.lineWidth = 4;
    ctx.lineCap = 'round';
    ctx.shadowBlur = 10;
    
    function drawGallows() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Base, Pole, Beam, Rope
        ctx.beginPath();
        ctx.moveTo(20, 230); ctx.lineTo(120, 230); // Base
        ctx.moveTo(70, 230); ctx.lineTo(70, 20);  // Pole
        ctx.moveTo(70, 20);  ctx.lineTo(200, 20); // Beam
        ctx.moveTo(200, 20); ctx.lineTo(200, 50); // Rope
        ctx.stroke();
    }

    function drawHangmanPart(part) {
        ctx.fillStyle = COLORS.FILL;
        ctx.strokeStyle = COLORS.FILL;
        switch(part) {
            case 1: // Head
                ctx.beginPath();
                ctx.arc(200, 70, 20, 0, Math.PI * 2);
                ctx.stroke();
                break;
            case 2: // Body
                ctx.beginPath();
                ctx.moveTo(200, 90); ctx.lineTo(200, 160);
                ctx.stroke();
                break;
            case 3: // Left Arm
                ctx.beginPath();
                ctx.moveTo(200, 110); ctx.lineTo(160, 140);
                ctx.stroke();
                break;
            case 4: // Right Arm
                ctx.beginPath();
                ctx.moveTo(200, 110); ctx.lineTo(240, 140);
                ctx.stroke();
                break;
            case 5: // Left Leg
                ctx.beginPath();
                ctx.moveTo(200, 160); ctx.lineTo(170, 200);
                ctx.stroke();
                break;
            case 6: // Right Leg
                ctx.beginPath();
                ctx.moveTo(200, 160); ctx.lineTo(230, 200);
                ctx.stroke();
                break;
            // Easy/Medium haben mehr Teile (Fehler)
            case 7: // Left Eye
                 ctx.beginPath(); ctx.arc(193, 65, 3, 0, Math.PI * 2); ctx.fill();
                 break;
            case 8: // Right Eye
                 ctx.beginPath(); ctx.arc(207, 65, 3, 0, Math.PI * 2); ctx.fill();
                 break;
        }
    }

    // --- Event Listeners ---
    startGameBtn.addEventListener('click', init);
    restartGameBtn.addEventListener('click', () => { modal.style.display = 'none'; init(); });
    closeModalBtn.addEventListener('click', () => { modal.style.display = 'none'; });

    saveScoreBtn.addEventListener('click', () => {
        const playerName = playerNameInput.value.trim() || 'ANONYM';
        if (score > 0) {
            fetch("{% url 'games:save_score' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ player_name: playerName, game: 'Galgenmännchen', score: score })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') window.location.href = "{% url 'games:highscores' %}";
            });
        }
    });

    init(); // Spiel beim Laden initialisieren
});
</script>
{% endblock %}
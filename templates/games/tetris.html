{% extends 'base.html' %}
{% block title %}Tetris{% endblock %}
{% block content %}
    <h2>Tetris</h2>

    <style>
        /* ... (alter Style-Block bleibt unverändert) ... */
        #game-container { display: flex; justify-content: center; align-items: flex-start; gap: 20px; }
        #game-board { border: 3px solid #32c8e6; background-color: #000; }
        #game-info { width: 150px; text-align: left; }
        #next-piece-canvas { border: 2px solid #533483; background-color: #000; }
        #overlay { position: absolute; top: 50%; left: 50%; transform: translate(calc(-50% - 10px), -50%); width: 300px; height: 600px; background-color: rgba(12, 12, 28, 0.9); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 1.2em; z-index: 100;}
        .difficulty-button { display: inline-block; text-decoration: none; padding: 15px 25px; margin: 10px; border-radius: 0; font-size: 1em; color: #FFFFFF; cursor: pointer; border: 2px solid; font-family: 'Press Start 2P', cursive; }
        .easy { background-color: #28a745; border-color: #28a745; }
        .medium { background-color: #ffc107; border-color: #ffc107; color: #1a1a2e;}
        .hard { background-color: #dc3545; border-color: #dc3545; }
    </style>

    <div id="game-container">
        <div id="main-game" style="position: relative;">
             <canvas id="game-board" width="300" height="600"></canvas>
             <div id="overlay">
                <h3>TETRIS</h3>
                <p>Wähle eine Schwierigkeitsstufe:</p>
                <div>
                    <button class="difficulty-button easy" onclick="startGame('easy')">Leicht</button>
                    <button class="difficulty-button medium" onclick="startGame('medium')">Mittel</button>
                    <button class="difficulty-button hard" onclick="startGame('hard')">Schwer</button>
                </div>
                <p style="font-size: 0.8em; margin-top: 40px;">Steuerung:<br>Pfeile: Bewegen/Drehen<br>Leertaste: Absetzen</p>
            </div>
        </div>
       
        <div id="game-info">
            <h3>Score</h3>
            <p id="score-display">0</p>
            <h3>Level</h3>
            <p id="level-display">1</p>
            <h3>Nächster Stein</h3>
            <canvas id="next-piece-canvas" width="120" height="120"></canvas>
        </div>
    </div>
    
    <script>
        // --- (Der JavaScript-Teil wurde angepasst) ---
        const canvas = document.getElementById('game-board');
        const context = canvas.getContext('2d');
        const nextCanvas = document.getElementById('next-piece-canvas');
        const nextContext = nextCanvas.getContext('2d');
        
        const overlay = document.getElementById('overlay');
        const scoreDisplay = document.getElementById('score-display');
        const levelDisplay = document.getElementById('level-display');

        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 30;
        
        const COLORS = [null, '#e94560', '#32c8e6', '#ffc107', '#28a745', '#533483', '#f07c3a', '#e0e0e0'];
        const SHAPES = [[], [[1,1,1,1]], [[2,2],[2,2]], [[0,3,0],[3,3,3]], [[4,4,0],[0,4,4]], [[0,5,5],[5,5,0]], [[6,0,0],[6,6,6]], [[0,0,7],[7,7,7]]];

        let board, piece, nextPiece, score, level, linesCleared, dropCounter, dropInterval, lastTime, isGameOver, gameLoopId, currentDifficulty;

        function createPiece() {
            const index = Math.floor(Math.random() * 7) + 1;
            return { matrix: SHAPES[index], color: COLORS[index], x: Math.floor(COLS / 2) - 1, y: 0 };
        }
        
        // --- KORREKTUR: startGame akzeptiert jetzt eine Schwierigkeit ---
        function startGame(difficulty) {
            currentDifficulty = difficulty;
            const speedMap = { easy: 1200, medium: 1000, hard: 700 };
            dropInterval = speedMap[difficulty];
            
            board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
            piece = createPiece();
            nextPiece = createPiece();
            score = 0; level = 1; linesCleared = 0;
            isGameOver = false;
            overlay.style.display = 'none';

            cancelAnimationFrame(gameLoopId);
            gameLoopId = requestAnimationFrame(update);
        }

        // --- (Der Rest des JavaScript-Codes bleibt fast gleich) ---
        function rotate(matrix) {
            const result = [];
            for (let y = 0; y < matrix[0].length; y++) {
                result[y] = [];
                for (let x = 0; x < matrix.length; x++) result[y][x] = matrix[matrix.length - 1 - x][y];
            }
            return result;
        }
        function collide(board, piece) {
            const { matrix, x, y } = piece;
            for (let row = 0; row < matrix.length; row++) {
                for (let col = 0; col < matrix[row].length; col++) {
                    if (matrix[row][col] && ((board[row + y] && board[row + y][col + x]) !== 0)) return true;
                }
            }
            return false;
        }
        function merge(board, piece) {
            const colorIndex = COLORS.indexOf(piece.color);
            piece.matrix.forEach((row, r) => {
                row.forEach((value, c) => {
                    if (value !== 0) board[r + piece.y][c + piece.x] = colorIndex;
                });
            });
        }
        function clearLines() {
            let cleared = 0;
            outer: for (let y = board.length - 1; y >= 0; y--) {
                for (let x = 0; x < board[y].length; x++) if (board[y][x] === 0) continue outer;
                board.splice(y, 1); board.unshift(Array(COLS).fill(0));
                y++; cleared++;
            }
            if (cleared > 0) {
                score += Math.pow(cleared, 2) * 100 * level;
                linesCleared += cleared;
                if (linesCleared >= level * 10) { level++; dropInterval = Math.max(100, 1000 - (level - 1) * 100); }
            }
        }
        function pieceDrop() {
            piece.y++;
            if (collide(board, piece)) {
                piece.y--;
                merge(board, piece);
                clearLines();
                piece = nextPiece;
                nextPiece = createPiece();
                if (collide(board, piece)) gameOver();
            }
            dropCounter = 0;
        }
        function drawMatrix(matrix, offset, ctx, useColor) {
            matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        ctx.fillStyle = useColor ? COLORS[value] : useColor;
                        ctx.fillRect((x + offset.x) * BLOCK_SIZE, (y + offset.y) * BLOCK_SIZE, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
                    }
                });
            });
        }
        function draw() {
            context.fillStyle = '#000';
            context.fillRect(0, 0, canvas.width, canvas.height);
            drawMatrix(board, {x: 0, y: 0}, context, true);
            drawMatrix(piece.matrix, {x: piece.x, y: piece.y}, context, piece.color);
            nextContext.fillStyle = '#000';
            nextContext.fillRect(0, 0, nextCanvas.width, nextCanvas.height);
            drawMatrix(nextPiece.matrix, {x: 1, y: 1}, nextContext, nextPiece.color);
        }
        function update(time = 0) {
            if (isGameOver) return;
            const deltaTime = time - lastTime;
            lastTime = time;
            dropCounter += deltaTime;
            if (dropCounter > dropInterval) pieceDrop();
            draw();
            scoreDisplay.textContent = score;
            levelDisplay.textContent = level;
            gameLoopId = requestAnimationFrame(update);
        }
        function gameOver() {
            cancelAnimationFrame(gameLoopId);
            isGameOver = true;
            overlay.style.display = 'flex';
            overlay.innerHTML = `
                <h3>Game Over!</h3><p>Dein Score: ${score}</p>
                <form id="highscore-form"><input type="text" id="player-name" placeholder="Dein Name..." required><button type="submit">Highscore speichern</button></form>
                <p style="margin-top:20px; font-size: 0.8em">Wähle eine Schwierigkeit für ein neues Spiel:</p>
                <div>
                    <button class="difficulty-button easy" onclick="startGame('easy')">Leicht</button>
                    <button class="difficulty-button medium" onclick="startGame('medium')">Mittel</button>
                    <button class="difficulty-button hard" onclick="startGame('hard')">Schwer</button>
                </div>`;
            document.getElementById('highscore-form').addEventListener('submit', function(event) {
                event.preventDefault();
                const playerName = document.getElementById('player-name').value;
                fetch("{% url 'games:save_score' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                    body: JSON.stringify({ player_name: playerName, score: score, game: 'Tetris', difficulty: currentDifficulty })
                }).then(() => window.location.href = "{% url 'games:highscores' %}");
            });
        }
        document.addEventListener('keydown', event => {
            if (isGameOver) return;
            if (event.key === 'ArrowLeft') { piece.x--; if (collide(board, piece)) piece.x++; }
            else if (event.key === 'ArrowRight') { piece.x++; if (collide(board, piece)) piece.x--; }
            else if (event.key === 'ArrowDown') { pieceDrop(); }
            else if (event.key === 'ArrowUp') {
                const rotated = rotate(piece.matrix);
                const posX = piece.x; let offset = 1;
                while (collide(board, { ...piece, matrix: rotated })) {
                    piece.x += offset; offset = -(offset + (offset > 0 ? 1 : -1));
                    if (offset > rotated[0].length) { piece.x = posX; return; }
                }
                piece.matrix = rotated;
            } else if (event.key === ' ') {
                 while (!collide(board, piece)) piece.y++;
                 piece.y--; pieceDrop();
            }
        });
    </script>
{% endblock %}
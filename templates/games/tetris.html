{% extends 'base.html' %}{% block content %}<h2>Tetris</h2><style>#game-container{display:flex;justify-content:center;align-items:flex-start;gap:20px}#main-game{position:relative}#game-board{border:3px solid #32c8e6;background-color:#000}#game-info{width:150px;text-align:left}#next-piece-canvas{border:2px solid #533483;background-color:#000}#overlay{position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(12,12,28,.9);color:#fff;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;font-size:1.2em;z-index:100}</style><div id="game-container"><div id="main-game"><canvas id="game-board" width="300" height="600"></canvas><div id="overlay"><h3>TETRIS</h3><p>Wähle eine Schwierigkeitsstufe:</p><div><button onclick="startGame('easy')">Leicht</button><button onclick="startGame('medium')">Mittel</button><button onclick="startGame('hard')">Schwer</button></div><p style="font-size:.8em;margin-top:40px">Steuerung: Pfeile & Leertaste</p></div></div><div id="game-info"><h3>Score</h3><p id="score-display">0</p><h3>Level</h3><p id="level-display">1</p><h3>Nächster Stein</h3><canvas id="next-piece-canvas" width="120" height="120"></canvas></div></div><script>const canvas=document.getElementById("game-board"),context=canvas.getContext("2d"),nextCanvas=document.getElementById("next-piece-canvas"),nextContext=nextCanvas.getContext("2d"),overlay=document.getElementById("overlay"),scoreDisplay=document.getElementById("score-display"),levelDisplay=document.getElementById("level-display"),COLS=10,ROWS=20,BLOCK_SIZE=30,COLORS=[null,"#e94560","#32c8e6","#ffc107","#28a745","#533483","#f07c3a","#e0e0e0"],SHAPES=[[],[[1,1,1,1]],[[2,2],[2,2]],[[0,3,0],[3,3,3]],[[4,4,0],[0,4,4]],[[0,5,5],[5,5,0]],[[6,0,0],[6,6,6]],[[0,0,7],[7,7,7]]];let board,piece,nextPiece,score,level,linesCleared,dropCounter,dropInterval,lastTime,isGameOver,gameLoopId,currentDifficulty;function createPiece(){const e=Math.floor(7*Math.random())+1;return{matrix:SHAPES[e],color:COLORS[e],x:4,y:0}}function rotate(e){const t=[];for(let o=0;o<e[0].length;o++){t[o]=[];for(let r=0;r<e.length;r++)t[o][r]=e[e.length-1-r][o]}return t}function collide(e,t){const{matrix:o,x:r,y:n}=t;for(let c=0;c<o.length;c++)for(let l=0;l<o[c].length;l++)if(o[c][l]&&(e[c+n]&&e[c+n][l+r])!==0)return!0;return!1}function merge(e,t){const o=COLORS.indexOf(t.color);t.matrix.forEach((r,n)=>{r.forEach((c,l)=>{0!==c&&(e[n+t.y][l+t.x]=o)})})}function clearLines(){let e=0;e:for(let t=board.length-1;0<=t;t--){for(let o=0;o<board[t].length;o++)if(0===board[t][o])continue e;board.splice(t,1),board.unshift(Array(COLS).fill(0)),t++,e++}0<e&&(score+=Math.pow(e,2)*100*level,linesCleared+=e,linesCleared>=10*level&&(level++,dropInterval=Math.max(100,dropInterval-100)))}function pieceDrop(){piece.y++,collide(board,piece)&&(piece.y--,merge(board,piece),piece=nextPiece,nextPiece=createPiece(),collide(board,piece)&&gameOver()),dropCounter=0}function drawMatrix(e,t,o,r){e.forEach((n,c)=>{n.forEach((l,i)=>{0!==l&&(o.fillStyle=r?COLORS[l]:r,o.fillRect((i+t.x)*BLOCK_SIZE,(c+t.y)*BLOCK_SIZE,BLOCK_SIZE-1,BLOCK_SIZE-1))})})}function draw(){context.fillStyle="#000",context.fillRect(0,0,300,600),drawMatrix(board,{x:0,y:0},context,!0),drawMatrix(piece.matrix,{x:piece.x,y:piece.y},context,piece.color),nextContext.fillStyle="#000",nextContext.fillRect(0,0,120,120),drawMatrix(nextPiece.matrix,{x:1,y:1},nextContext,nextPiece.color)}function update(e=0){if(isGameOver)return;const t=e-lastTime;lastTime=e,dropCounter+=t,dropCounter>dropInterval&&pieceDrop(),draw(),scoreDisplay.textContent=score,levelDisplay.textContent=level,gameLoopId=requestAnimationFrame(update)}function startGame(e){currentDifficulty=e;const t={easy:1200,medium:1e3,hard:700};dropInterval=t[e],board=Array.from({length:ROWS},()=>Array(COLS).fill(0)),piece=createPiece(),nextPiece=createPiece(),score=0,level=1,linesCleared=0,isGameOver=!1,overlay.style.display="none",cancelAnimationFrame(gameLoopId),gameLoopId=requestAnimationFrame(update)}function gameOver(){cancelAnimationFrame(gameLoopId),isGameOver=!0,overlay.style.display="flex",overlay.innerHTML=<h3>Game Over!</h3><p>Dein Score: \</p><form id="highscore-form"><input type="text" id="player-name" placeholder="Dein Name..." required><button type="submit">Highscore speichern</button></form><p>Neues Spiel:</p><div><button onclick="startGame('easy')">Leicht</button>...</div>,document.getElementById("highscore-form").addEventListener("submit",function(e){e.preventDefault(),fetch("{% url 'games:save_score' %}",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":"{{ csrf_token }}"},body:JSON.stringify({player_name:document.getElementById("player-name").value,score:score,game:"Tetris",difficulty:currentDifficulty})}).then(()=>window.location.href="{% url 'games:highscores' %}")})}document.addEventListener("keydown",e=>{if(isGameOver)if("ArrowLeft"===e.key)piece.x--,collide(board,piece)&&piece.x++;else if("ArrowRight"===e.key)piece.x++,collide(board,piece)&&piece.x--;else if("ArrowDown"===e.key)pieceDrop();else if("ArrowUp"===e.key){const t=rotate(piece.matrix);let o=1,r=piece.x;for(;collide(board,{...piece,matrix:t});){if(piece.x+=o,o=-(o+(0<o?1:-1)),o>t[0].length)return void(piece.x=r)}piece.matrix=t}else" "===e.key&&(function(){for(;!collide(board,piece);)piece.y++;piece.y--}(),pieceDrop())});</script>{% endblock %}
